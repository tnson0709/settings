<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thiết lập bảng giá điện, nước, phí dịch vụ</title>
  <style>
    /* CSS hiện đại, nhẹ nhàng */
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      margin: 0; padding: 0;
      color: #333;
    }
    header {
      padding: 1rem 2rem;
      background-color: #2a9d8f;
      color: white;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
      letter-spacing: 1px;
    }
    main {
      max-width: 960px;
      margin: 2rem auto;
      background: white;
      border-radius: 8px;
      padding: 2rem;
      box-shadow: 0 2px 10px rgb(0 0 0 / 0.1);
    }
    h2 {
      margin-top: 0;
      color: #264653;
    }
    form > section {
      margin-bottom: 2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.5rem 1rem;
      text-align: center;
    }
    th {
      background: #e9f5f2;
      font-weight: 600;
    }
    input[type="number"], input[type="text"] {
      width: 100%;
      padding: 6px 10px;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 1rem;
      text-align: right;
    }
    input[type="number"]:focus, input[type="text"]:focus {
      border-color: #2a9d8f;
      outline: none;
      box-shadow: 0 0 5px #2a9d8f66;
    }
    button {
      background-color: #2a9d8f;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: background-color 0.25s ease;
    }
    button:hover {
      background-color: #21867a;
    }
    .btn-add-row {
      margin-top: 0.5rem;
      background-color: #e76f51;
    }
    .btn-remove-row {
      background: #e63946;
      font-size: 0.9rem;
      padding: 0.3rem 0.6rem;
    }
    .btn-remove-row:hover {
      background: #c5303f;
    }
    .actions {
      text-align: right;
      margin-top: 2rem;
    }
    .status {
      margin-top: 1rem;
      font-weight: 600;
      color: #264653;
    }
  </style>
</head>
<body>
  <header>Thiết Lập Bảng Giá Điện, Nước, Phí Dịch Vụ</header>
  <main>
    <form id="pricing-form">
      <!-- Giá điện theo bậc -->
      <section>
        <h2>Giá điện theo bậc</h2>
        <table id="elec-table">
          <thead>
            <tr>
              <th>Bậc</th>
              <th>Giá (VNĐ/kWh)</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody>
            <!-- Rows động chèn vào đây -->
          </tbody>
        </table>
        <button type="button" class="btn-add-row" data-target="elec-table">+ Thêm bậc</button>
      </section>
      <!-- Giá nước theo bậc -->
      <section>
        <h2>Giá nước theo bậc</h2>
        <table id="water-table">
          <thead>
            <tr>
              <th>Bậc</th>
              <th>Giá (VNĐ/m³)</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button type="button" class="btn-add-row" data-target="water-table">+ Thêm bậc</button>
      </section>
      <!-- Phí dịch vụ theo m2 -->
      <section>
        <h2>Phí dịch vụ theo m²</h2>
        <label for="serviceFee">Phí (VNĐ/m²): </label>
        <input type="number" id="serviceFee" name="serviceFee" min="0" step="1000" value="5000" />
      </section>
      <div class="actions">
        <button type="submit">Lưu dữ liệu (local)</button>
        <button type="button" id="sync-btn">Đồng bộ lên server</button>
        <div class="status" id="status-msg"></div>
      </div>
    </form>
  </main>
  <script>
    // Utils
    function formatCurrency(value) {
      return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    // IndexedDB setup
    const DB_NAME = "PricingDB";
    const DB_VERSION = 1;
    let db;
    // Open DB, create object store
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => reject("Không thể mở database");
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains("pricing")) {
            const store = db.createObjectStore("pricing", {keyPath: "id"});
          }
        };
      });
    }
    // Save pricing data to DB
    function saveData(data) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction("pricing", "readwrite");
        const store = tx.objectStore("pricing");
        store.put(data);
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject("Lỗi lưu dữ liệu");
      });
    }
    // Load pricing data from DB
    function loadData() {
      return new Promise((resolve, reject) => {
        const tx = db.transaction("pricing", "readonly");
        const store = tx.objectStore("pricing");
        const request = store.get("main");
        request.onsuccess = () => resolve(request.result ? request.result.data : null);
        request.onerror = () => reject("Lỗi đọc dữ liệu");
      });
    }
    // DOM elements
    const elecTableBody = document.querySelector("#elec-table tbody");
    const waterTableBody = document.querySelector("#water-table tbody");
    const serviceFeeInput = document.querySelector("#serviceFee");
    const form = document.querySelector("#pricing-form");
    const statusMsg = document.getElementById("status-msg");
    const syncBtn = document.getElementById("sync-btn");
    // Add a row to table
    function addRow(tableBody, bậc = "", giá = "") {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="number" min="1" step="1" class="step-input" value="${bậc}"/></td>
        <td><input type="number" min="0" step="100" class="price-input" value="${giá}"/></td>
        <td><button type="button" class="btn-remove-row">Xóa</button></td>
      `;
      // Format on input
      tr.querySelector(".price-input").addEventListener("input", e => {
        // no special formatting here, just plain numbers; format on blur if needed
      });
      tr.querySelector(".btn-remove-row").addEventListener("click", () => {
        tr.remove();
      });
      tableBody.appendChild(tr);
    }
    // Load data to form
    function loadToForm(data) {
	  elecTableBody.innerHTML = "";
	  waterTableBody.innerHTML = "";
	  if (data) {
	    if (data.electricity && data.electricity.length) {
	      data.electricity.forEach(item => addRow(elecTableBody, item.step, item.price));
	    } else {
	      // Mặc định bậc giá điện nhà nước 2025
	      [
		{step:1, price:1549},
		{step:2, price:1600},
		{step:3, price:2615},
		{step:4, price:2701},
		{step:5, price:2927},
		{step:6, price:2995},
	      ].forEach(item => addRow(elecTableBody, item.step, item.price));
	    }
	    if (data.water && data.water.length) {
	      data.water.forEach(item => addRow(waterTableBody, item.step, item.price));
	    } else {
	      // Mặc định bậc giá nước sinh hoạt
	      [
		{step:1, price:4400},
		{step:2, price:5360},
		{step:3, price:6360},
		{step:4, price:7450},
	      ].forEach(item => addRow(waterTableBody, item.step, item.price));
	    }
	    serviceFeeInput.value = data.serviceFee ||

	 "";
	  } else {
	    // Lần đầu chưa có data, cho mặc định
	    [
	      {step:1, price:1549},
	      {step:2, price:1600},
	      {step:3, price:2615},
	      {step:4, price:2701},
	      {step:5, price:2927},
	      {step:6, price:2995},
	    ].forEach(item => addRow(elecTableBody, item.step, item.price));
	    [
	      {step:1, price:4400},
	      {step:2, price:5360},
	      {step:3, price:6360},
	      {step:4, price:7450},
	    ].forEach(item => addRow(waterTableBody, item.step, item.price));
	    serviceFeeInput.value = "";
	  }
	}

    // Read data from form
    function readFormData() {
      function readTable(tableBody) {
        const rows = [...tableBody.querySelectorAll("tr")];
        return rows
          .map(tr => {
            const step = tr.querySelector(".step-input").value;
            const price = tr.querySelector(".price-input").value;
            if (!step || !price) return null;
            return {step: Number(step), price: Number(price)};
          })
          .filter(x => x !== null)
          .sort((a,b) => a.step - b.step);
      }
      return {
        electricity: readTable(elecTableBody),
        water: readTable(waterTableBody),
        serviceFee: Number(serviceFeeInput.value) ||

 0
      };
    }
    // Save form data to IndexedDB
    async function saveFormData() {
      const data = readFormData();
      await saveData({id: "main", data});
      statusMsg.textContent = "Đã lưu dữ liệu vào local.";
      setTimeout(() => (statusMsg.textContent = ""), 3000);
    }
    // Sync data to server
    async function syncData() {
      const data = readFormData();
      statusMsg.textContent = "Đang đồng bộ...";
      try {
        // Giả định API endpoint
        const response = await fetch("https://example.com/api/pricing/sync", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(data)
        });
        if (!response.ok) throw new Error(`Lỗi đồng bộ: ${response.status}`);
        statusMsg.textContent = "Đồng bộ thành công!";
      } catch (error) {
        statusMsg.textContent = `Đồng bộ lỗi: ${error.message}`;
      }
      setTimeout(() => (statusMsg.textContent = ""), 4000);
    }
    // Setup initial events
    async function init() {
      await openDB();
      const data = await loadData();
      loadToForm(data);
    }
    // Event listeners
    form.addEventListener("submit", e => {
      e.preventDefault();
      saveFormData();
    });
    // Thêm hàng động cho các nút +Thêm bậc
    document.querySelectorAll(".btn-add-row").forEach(btn => {
      btn.addEventListener("click", () => {
        const targetId = btn.dataset.target;
        const tableBody = document.getElementById(targetId).querySelector("tbody");
        addRow(tableBody);
      });
    });
    // Đồng bộ nút
    syncBtn.addEventListener("click", () => {
      syncData();
    });
    init();
  </script>
</body>
</html>

